# T-004.5: Runtime Feature Gating

**Status**: âœ… Complete
**Completed**: 2026-01-24
**Commit**: `1ebedef` - T-004.5: Runtime feature gating - Version checks
**Phase**: Phase 1 (Foundation)
**Progress After**: 5/20 tasks (25%)

---

## ğŸ¯ What Was Done

- Implemented runtime feature gating to reject unsupported v0.2+ and v0.3+ features
- Hard blocks for incompatible features (conditional routing)
- Soft blocks with warnings for future features (optimization, MLFlow)
- Helpful error messages with version timelines and workarounds
- Feature support query API
- 19 comprehensive tests for all feature gates
- Total: 172 tests passing (up from 153)

---

## ğŸ“¦ Files Created

### Source Code

```
src/configurable_agents/runtime/
â””â”€â”€ feature_gate.py (runtime version checks and feature gating)
```

### Tests

```
tests/runtime/
â”œâ”€â”€ __init__.py
â””â”€â”€ test_feature_gate.py (19 comprehensive tests)
```

---

## ğŸ”§ How to Verify

### 1. Test feature gates

```bash
pytest tests/runtime/test_feature_gate.py -v
# Expected: 19 passed
```

### 2. Run full test suite

```bash
pytest -v
# Expected: 172 passed (19 runtime + 153 existing)
```

### 3. Use feature gating

```python
from configurable_agents.config import parse_config_file, WorkflowConfig
from configurable_agents.runtime import validate_runtime_support, UnsupportedFeatureError

# Load config
config_dict = parse_config_file("workflow.yaml")
config = WorkflowConfig(**config_dict)

# Check runtime support (raises if unsupported features)
try:
    validate_runtime_support(config)
    print("âœ… Config is compatible with v0.1 runtime")
except UnsupportedFeatureError as e:
    print(f"âŒ {e}")
    print(f"   Available in: {e.available_in}")
    print(f"   Timeline: {e.timeline}")
    print(f"   Workaround: {e.workaround}")
```

### 4. Query feature support

```python
from configurable_agents.runtime import check_feature_support

# Check if a feature is supported
result = check_feature_support("Conditional routing (if/else)")
print(f"Supported: {result['supported']}")
print(f"Available in: {result['version']}")
print(f"Timeline: {result['timeline']}")
```

---

## âœ… What to Expect

**Working**:
- âœ… Configs with v0.2+ features are rejected at runtime with clear errors
- âœ… Configs with v0.3+ features trigger warnings but still run (degraded mode)
- âœ… Error messages include version info, timeline, and workarounds
- âœ… Valid v0.1 configs pass without errors or warnings
- âœ… Feature support can be queried programmatically

**Not Yet Working**:
- âŒ No actual runtime execution yet (T-013: Runtime Executor)
- âŒ Feature gates are validated but not enforced during execution

---

## ğŸ’» Public API

### Main Validation Function

```python
from configurable_agents.runtime import validate_runtime_support, UnsupportedFeatureError

# Validate runtime support (raises if unsupported)
try:
    validate_runtime_support(config)
except UnsupportedFeatureError as e:
    print(f"Error: {e}")
    print(f"Available in: {e.available_in}")
    print(f"Timeline: {e.timeline}")
    print(f"Workaround: {e.workaround}")
```

### Feature Query API

```python
from configurable_agents.runtime import get_supported_features, check_feature_support

# Get all supported features
features = get_supported_features()
for feature in features:
    print(f"{feature['name']}: {feature['supported']}")

# Check specific feature
result = check_feature_support("Conditional routing (if/else)")
if not result['supported']:
    print(f"Available in {result['version']} ({result['timeline']})")
```

### Complete Public API

```python
# From configurable_agents.runtime

from configurable_agents.runtime import (
    UnsupportedFeatureError,      # Exception for hard blocks
    validate_runtime_support,      # Main validation function
    get_supported_features,        # Get feature list
    check_feature_support,         # Check specific feature
)
```

---

## ğŸ“š Dependencies Used

- Standard library only (warnings module)
- Depends on config models from T-003

---

## ğŸ’¡ Design Decisions

### Why Hard vs Soft Blocks?

**Hard Blocks (UnsupportedFeatureError)**:
- For features that fundamentally change execution flow
- Example: Conditional routing requires different graph traversal
- Can't run workflow without implementing the feature
- Raises error immediately

**Soft Blocks (UserWarning)**:
- For additive features that don't change core execution
- Example: Optimization would enhance results but isn't required
- Workflow can run in degraded mode (without the feature)
- Warns user but allows execution

### Why Include Timeline Info?

- Sets user expectations (not "coming soon", but "8-12 weeks")
- Helps users decide whether to wait or use workaround
- Transparent about development roadmap
- Reduces support burden ("When will X be available?")

### Why Workaround Suggestions?

- Helps users unblock themselves immediately
- Example: "Use multiple workflows" instead of conditional routing
- Reduces frustration when feature isn't available
- Shows we understand user needs

### Why Feature Query API?

- Allows tooling to check feature support programmatically
- Example: Config editor can disable unsupported features in UI
- Reduces user errors (don't let them configure unsupported features)
- Future-proof: as features are added, queries return updated info

---

## ğŸ§ª Tests Created

**File**: `tests/runtime/test_feature_gate.py`

### Test Categories (19 tests total)

1. **Valid Configs** (3 tests)
   - Minimal v0.1 config passes
   - Complex v0.1 config passes
   - All supported features pass

2. **Hard Blocks - Conditional Routing** (4 tests)
   - Conditional routing blocked (UnsupportedFeatureError)
   - Error message includes timeline
   - Error message includes workaround
   - Error message includes version info

3. **Soft Blocks - Optimization** (4 tests)
   - Global optimization warns (UserWarning)
   - Node-level optimization warns (UserWarning)
   - Warning includes timeline
   - Workflow can still run (no error)

4. **Soft Blocks - MLFlow** (2 tests)
   - MLFlow observability warns (UserWarning)
   - Warning message includes alternative (console logging)

5. **Feature Query API** (4 tests)
   - get_supported_features() returns all features
   - check_feature_support() returns correct info
   - Supported features return supported=True
   - Unsupported features return timeline

6. **Multiple Features** (2 tests)
   - Config with multiple unsupported features
   - First hard block raises error (fail-fast)

---

## âœ… Feature Gating System

### Hard Blocks (UnsupportedFeatureError)

**Conditional Routing** (v0.2+ feature):
- âœ… Detected by: edge has 'routes' field
- âœ… Error message: "Conditional routing not supported in v0.1"
- âœ… Available in: v0.2
- âœ… Timeline: 8-12 weeks from initial release
- âœ… Workaround: Use linear edges (from/to) instead. Create multiple workflows and chain externally.

### Soft Blocks (UserWarning)

**Global DSPy Optimization** (v0.3+ feature):
- âœ… Detected by: optimization.enabled = true
- âœ… Warning: "DSPy optimization will be IGNORED"
- âœ… Available in: v0.3
- âœ… Timeline: 12-16 weeks from initial release
- âœ… Behavior: Workflow runs without optimization

**Node-Level Optimization** (v0.3+ feature):
- âœ… Detected by: node.optimize.enabled = true
- âœ… Warning: "Node optimization will be IGNORED"
- âœ… Available in: v0.3
- âœ… Timeline: 12-16 weeks from initial release
- âœ… Behavior: Node runs without optimization

**MLFlow Observability** (v0.2+ feature):
- âœ… Detected by: config.observability.mlflow is set
- âœ… Warning: "MLFlow tracking will be IGNORED"
- âœ… Available in: v0.2
- âœ… Timeline: 8-12 weeks from initial release
- âœ… Behavior: Only console logging available

### Supported in v0.1

- âœ… Basic logging (config.observability.logging)
- âœ… Linear workflows (edges with from/to)
- âœ… All core features (state, nodes, LLM, tools)
- âœ… Type-enforced outputs
- âœ… Prompt templates with variables

---

## ğŸ“– Example Error Messages

### Hard Block - Conditional Routing

```
UnsupportedFeatureError: Feature 'Conditional routing (edge routes)' is not supported in v0.1
Available in: v0.2
Estimated timeline: 8-12 weeks from initial release

Workaround: Use linear edges (from/to) instead. For decision logic, create multiple separate workflows and chain them externally.

See roadmap: docs/PROJECT_VISION.md
```

### Soft Block - Optimization

```
UserWarning: DSPy optimization (optimization.enabled=true) is not supported in v0.1.
This setting will be IGNORED. Available in: v0.3 (12-16 weeks from initial release).
Your workflow will run without optimization. See docs/PROJECT_VISION.md for roadmap.
```

### Soft Block - MLFlow

```
UserWarning: MLFlow observability is not supported in v0.1.
MLFlow tracking will be IGNORED. Only console logging available.
Available in: v0.2 (8-12 weeks from initial release).
See docs/PROJECT_VISION.md for roadmap.
```

---

## ğŸ“– Documentation Updated

- âœ… CHANGELOG.md (comprehensive entry created)
- âœ… docs/TASKS.md (T-004.5 marked DONE, progress updated to 5/20)
- âœ… docs/DISCUSSION.md (status updated)
- âœ… README.md (progress statistics updated)

---

## ğŸ“ Git Commit Template

```bash
git add .
git commit -m "T-004.5: Runtime feature gating - Version checks

- Implemented feature gating for v0.2+ and v0.3+ features
  - Hard blocks: Conditional routing (UnsupportedFeatureError)
  - Soft blocks: Optimization, MLFlow (UserWarning)
  - Clear error messages with timelines and workarounds

- Feature support query API
  - get_supported_features() - list all features
  - check_feature_support(name) - check specific feature
  - Returns version, timeline, support status

- Comprehensive error messages
  - Feature name and version when available
  - Timeline estimate (8-12 weeks, 12-16 weeks, etc.)
  - Workarounds for v0.1
  - Links to roadmap documentation

- Created 19 comprehensive tests
  - Valid v0.1 configs pass
  - Conditional routing blocked (hard)
  - Optimization warned (soft)
  - MLFlow observability warned (soft)
  - Multiple feature combinations
  - Feature query API

Verification:
  pytest -v
  Expected: 172 passed (19 runtime + 153 existing)

Progress: 5/20 tasks (25%) - Foundation phase
Next: T-005 (Type System - mostly done in T-003)"
```

---

## ğŸ”— Related Documentation

- **[../../TASKS.md](../../TASKS.md)** - Task T-004.5 acceptance criteria
- **[../../PROJECT_VISION.md](../../PROJECT_VISION.md)** - Feature roadmap and timelines
- **[../../ARCHITECTURE.md](../../ARCHITECTURE.md)** - Runtime feature gate component
- **[../../SPEC.md](../../SPEC.md)** - Schema v1.0 specification (all versions)

---

*Implementation completed: 2026-01-24*
*Next task: T-005 (Type System - Formal Closure)*
