FROM python:3.10-slim

# Install system dependencies
RUN apt-get update && apt-get install -y git build-essential

# 1. Install uv
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

WORKDIR /app

# 2. Copy dependency files first (for caching)
# The spawner must copy pyproject.toml and uv.lock here
COPY pyproject.toml uv.lock /app/

# 3. Install dependencies using uv
# --system: install into system python (no venv needed in container)
# --deploy: fail if lockfile is out of sync
RUN uv pip install --system --no-cache -r pyproject.toml

# 4. Copy source code and install the package itself
COPY src /app/src
RUN uv pip install --system --no-deps -e .

# 5. Inject the specific flow configuration
COPY flow.yaml /app/flow.yaml

# 6. Environment Setup
ENV FLOW_CONFIG=/app/flow.yaml

# 7. Network & Start
EXPOSE 8000
CMD ["uvicorn", "configurable_agents.server:app", "--host", "0.0.0.0", "--port", "8000"]