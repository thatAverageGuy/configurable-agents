# Test Config 06: Loop Iteration
# Purpose: Verify loop execution with max iterations
# Test: configurable-agents run test_configs/06_loop_iteration.yaml --input target_count="3"

schema_version: "1.0"

flow:
  name: test_06_loop
  description: Workflow with loop iteration
  version: "1.0.0"

state:
  fields:
    target_count:
      type: int
      required: true
      description: Number of iterations to perform
    current_iteration:
      type: int
      default: 0
      description: Current iteration number
    accumulated:
      type: str
      default: ""
      description: Accumulated results from each iteration
    # Loop termination field (must be bool for loop.condition_field)
    loop_complete:
      type: bool
      default: false
      description: Set to true when loop should exit

nodes:
  - id: iterate
    description: Perform one iteration
    prompt: |
      This is iteration {state.current_iteration} of {state.target_count}.
      Previous accumulated: {state.accumulated}

      Add a short phrase for this iteration (e.g., "Iteration X complete. ").

      IMPORTANT:
      - Increment current_iteration by 1
      - If the NEW current_iteration >= target_count, set loop_complete to true
      - Otherwise set loop_complete to false
    outputs: [current_iteration, accumulated, loop_complete]
    output_schema:
      type: object
      fields:
        - name: current_iteration
          type: int
          description: Incremented iteration counter (add 1 to current value)
        - name: accumulated
          type: str
          description: Updated accumulated string
        - name: loop_complete
          type: bool
          description: True if current_iteration >= target_count after increment

  - id: finalize
    description: Finalize the loop results
    prompt: |
      Loop completed with {state.current_iteration} iterations.
      Final accumulated: {state.accumulated}

      Provide a brief summary of the loop completion.
    outputs: [accumulated]
    output_schema:
      type: object
      fields:
        - name: accumulated
          type: str
          description: Final summary

edges:
  - from: START
    to: iterate

  # Loop edge using correct schema format
  - from: iterate
    loop:
      max_iterations: 5
      condition_field: "loop_complete"
      exit_to: finalize

  - from: finalize
    to: END

config:
  llm:
    provider: google
    model: gemini-2.5-flash-lite
    temperature: 0.7
