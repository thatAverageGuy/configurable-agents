{% extends "base.html" %}

{% block head %}
<style>
.comparison-table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
}

.comparison-table th,
.comparison-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.comparison-table th {
    background-color: # #f5f5f5;
    font-weight: 600;
}

.comparison-table tr:hover {
    background-color: #f9f9f9;
}

.best-badge {
    background-color: #d4edda;
    color: #155724;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.85rem;
    margin-left: 8px;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin: 20px 0;
}

.metric-card {
    background-color: #f8f9fa;
    padding: 16px;
    border-radius: 8px;
}

.metric-card h4 {
    margin: 0 0 8px 0;
    font-size: 0.9rem;
    color: #666;
}

.metric-value {
    font-size: 1.5rem;
    font-weight: 600;
}

.btn-apply {
    padding: 10px 20px;
    background-color: #28a745;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    margin-top: 20px;
}

.btn-apply:hover {
    background-color: #218838;
}

.btn-secondary {
    padding: 8px 16px;
    background-color: #6c757d;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    margin-right: 10px;
}

.btn-secondary:hover {
    background-color: #5a6268;
}

.diff-container {
    margin: 20px 0;
    padding: 16px;
    background-color: #f8f9fa;
    border-radius: 8px;
}

.diff-current,
.diff-new {
    padding: 12px;
    border-radius: 4px;
    margin-bottom: 12px;
    font-family: monospace;
    white-space: pre-wrap;
    word-break: break-all;
}

.diff-current {
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
}

.diff-new {
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
}

.alert {
    padding: 15px;
    border-radius: 4px;
    margin: 20px 0;
}

.alert-warning {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
}

.alert-danger {
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}
</style>
{% endblock %}

{% block title %}Experiment Comparison - {{ experiment }}{% endblock %}

{% block nav_dashboard %}class="active"{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Experiment: {{ experiment }}</h1>
    <p>Comparing variants by <code>{{ metric }}</code></p>

    <a href="/optimization/experiments" class="btn-secondary">&larr; Back to Experiments</a>
</div>

{% if mlflow_available is defined and not mlflow_available %}
<div class="alert alert-warning" style="padding: 20px; margin: 20px 0; border-radius: 8px;">
    <h2>MLFlow Not Available</h2>
    <p>The optimization features require MLFlow to be configured.</p>

    <h3>To enable MLFlow:</h3>
    <ul>
        <li>Install MLFlow: <code>pip install mlflow</code></li>
        <li>Restart the dashboard: MLFlow UI auto-starts when installed
            <code>configurable-agents ui</code>
        </li>
        <li>Or connect to external MLFlow server:
            <code>configurable-agents ui --mlflow-uri &lt;your-uri&gt;</code>
        </li>
    </ul>

    <p><a href="/optimization/experiments" class="btn-secondary">Refresh Status</a></p>
</div>
{% else %}

{% if error %}
<div class="alert alert-danger">
    {% if 'MLFlow' in error or 'mlflow' in error or 'not available' in error %}
    <strong>MLFlow Error:</strong> {{ error }}
    <p>Please ensure MLFlow is configured and accessible.</p>
    {% else %}
    <strong>Error:</strong> {{ error }}
    {% endif %}
</div>
{% endif %}

{% if comparison %}
<div id="comparison-container">
    <h2>Variant Comparison</h2>

    <table class="comparison-table">
        <thead>
            <tr>
                <th>Rank</th>
                <th>Variant</th>
                <th>Runs</th>
                <th>Avg Cost</th>
                <th>Avg Latency (ms)</th>
                <th>Tokens</th>
            </tr>
        </thead>
        <tbody>
            {% for variant in comparison.variants %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>
                    {{ variant.name }}
                    {% if variant.name == comparison.best_variant %}
                        <span class="best-badge">BEST</span>
                    {% endif %}
                </td>
                <td>{{ variant.run_count }}</td>
                <td>${{ variant.metrics.cost_usd_avg|round(6) if variant.metrics.cost_usd_avg else "-" }}</td>
                <td>{{ variant.metrics.duration_ms_avg|round(2) if variant.metrics.duration_ms_avg_avg else "-" }}</td>
                <td>{{ variant.metrics.total_tokens_avg|round(0) if variant.metrics.total_tokens_avg else "-" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="metrics-grid">
        {% for variant in comparison.variants %}
        <div class="metric-card">
            <h4>{{ variant.name }}</h4>
            <div class="metric-value">${{ variant.metrics.cost_usd_avg|round(6) if variant.metrics.cost_usd_avg else "0" }}</div>
            <div>Average Cost</div>
        </div>
        {% endfor %}
    </div>

    <h2>Apply Best Prompt</h2>
    <p>Apply the best performing prompt back to your workflow configuration.</p>

    <button id="apply-btn" class="btn-apply" onclick="showApplyModal()">
        Apply Best Variant ({{ comparison.best_variant }})
    </button>
</div>

<div id="apply-modal" style="display: none;">
    <div style="background: rgba(0,0,0,0.5); position: fixed; top: 0; left: 0; width: 100%; height: 100%; padding: 20px;">
        <div style="background: white; max-width: 600px; margin: 100px auto; padding: 20px; border-radius: 8px;">
            <h2>Apply Optimized Prompt</h2>

            <p>Apply the prompt from variant <strong>{{ comparison.best_variant }}</strong> to your workflow?</p>

            <div class="diff-container">
                <div class="diff-current"><strong>Current prompt will be replaced with:</strong></div>
                <div class="diff-new" id="apply-preview">Loading...</div>
            </div>

            <div style="margin-top: 20px;">
                <button class="btn-apply" onclick="confirmApply()">Confirm Apply</button>
                <button class="btn-secondary" onclick="cancelApply()">Cancel</button>
            </div>
        </div>
    </div>
</div>

<form id="apply-form" method="post" action="/optimization/apply" style="display: none;">
    <input type="hidden" name="experiment" value="{{ experiment }}">
    <input type="hidden" name="variant" value="">
    <input type="hidden" name="workflow_path" value="">
    <input type="hidden" name="dry_run" value="false">
</form>

<script>
function showApplyModal() {
    document.getElementById('apply-modal').style.display = 'block';
    loadPromptPreview();
}

function cancelApply() {
    document.getElementById('apply-modal').style.display = 'none';
}

function loadPromptPreview() {
    const preview = document.getElementById('apply-preview');
    preview.textContent = 'Loading preview...';

    fetch('/optimization/apply', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            experiment: '{{ experiment }}',
            variant: '{{ comparison.best_variant }}',
            workflow_path: window.location.pathname.split('/')[1] || 'workflow.yaml',
            dry_run: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.dry_run) {
            preview.innerHTML = `
                <strong>Current Prompt:</strong>
                <pre>${escapeHtml(data.current_prompt || 'N/A')}</pre>

                <strong>New Prompt ({{ comparison.best_variant }}):</strong>
                <pre>${escapeHtml(data.new_prompt || 'N/A')}</pre>
            `;
        } else if (data.error) {
            preview.innerHTML = `<span style="color: red;">Error: ${escapeHtml(data.error)}</span>`;
        } else {
            preview.innerHTML = '<span style="color: red;">Failed to load prompt preview</span>';
        }
    })
    .catch(err => {
        preview.innerHTML = `<span style="color: red;">Error: ${escapeHtml(err.message)}</span>`;
    });
}

function confirmApply() {
    const form = document.getElementById('apply-form');
    form.elements['variant'].value = '{{ comparison.best_variant }}';
    form.elements['workflow_path'].value = window.location.pathname.split('/')[1] || 'workflow.yaml';
    form.submit();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% else %}
<p>No comparison data available. Please <a href="/optimization/experiments">select an experiment</a>.</p>
{% endif %}
{% endif %}
{% endblock %}
