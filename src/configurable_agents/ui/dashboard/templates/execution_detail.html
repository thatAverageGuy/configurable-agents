{% extends "base.html" %}

{% block title %}{{ execution.workflow_name }} - Configurable Agents Dashboard{% endblock %}

{% block nav_executions %}class="active"{% endblock %}

{% block content %}
<div class="dashboard-container">
    <header class="page-header">
        <div>
            <h1>{{ execution.workflow_name }}</h1>
            <p class="subtitle">Run ID: {{ execution.id }}</p>
        </div>
        <a href="/executions" class="btn btn-secondary">Back to Executions</a>
    </header>

    <!-- Status Cards -->
    <div class="summary-cards">
        <div class="card">
            <div class="card-icon workflows-icon"></div>
            <div class="card-content">
                <div class="card-label">Status</div>
                <div class="card-value">
                    {% set status_class = {
                        'running': 'badge-running',
                        'completed': 'badge-completed',
                        'failed': 'badge-failed',
                        'pending': 'badge-pending',
                        'cancelled': 'badge-cancelled'
                    }.get(execution.status, 'badge-pending') %}
                    <span class="badge {{ status_class }}" style="font-size: 1rem;">{{ execution.status }}</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-icon running-icon"></div>
            <div class="card-content">
                <div class="card-label">Duration</div>
                <div class="card-value">{{ format_duration(execution.duration_seconds) }}</div>
            </div>
        </div>

        <div class="card">
            <div class="card-icon cost-icon"></div>
            <div class="card-content">
                <div class="card-label">Cost</div>
                <div class="card-value">{{ format_cost(execution.total_cost_usd) }}</div>
            </div>
        </div>

        <div class="card">
            <div class="card-icon agents-icon"></div>
            <div class="card-content">
                <div class="card-label">Tokens</div>
                <div class="card-value">{{ execution.total_tokens or 0 }}</div>
            </div>
        </div>
    </div>

    <!-- Details Section -->
    <div class="table-container">
        <div class="table-header">
            <h2>Execution Details</h2>
        </div>
        <div class="details-content">
            <div class="detail-row">
                <span class="detail-label">Run ID:</span>
                <span class="detail-value monospace">{{ execution.id }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Workflow Name:</span>
                <span class="detail-value">{{ execution.workflow_name }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Status:</span>
                <span class="detail-value">
                    <span class="badge {{ status_class }}">{{ execution.status }}</span>
                </span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Started At:</span>
                <span class="detail-value">{{ format_datetime(execution.started_at) }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Completed At:</span>
                <span class="detail-value">{{ format_datetime(execution.completed_at) }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Duration:</span>
                <span class="detail-value">{{ format_duration(execution.duration_seconds) }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Total Tokens:</span>
                <span class="detail-value">{{ execution.total_tokens or '-' }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Total Cost:</span>
                <span class="detail-value">{{ format_cost(execution.total_cost_usd) }}</span>
            </div>

            {% if execution.error_message %}
            <div class="detail-row">
                <span class="detail-label">Error:</span>
                <span class="detail-value error-message">{{ execution.error_message }}</span>
            </div>
            {% endif %}
        </div>
    </div>

    {% if bottleneck_info %}
    <!-- Bottleneck Analysis -->
    <div class="table-container">
        <div class="table-header">
            <h2>Bottleneck Analysis</h2>
        </div>
        <div class="details-content">
            <div class="detail-row">
                <span class="detail-label">Nodes Executed:</span>
                <span class="detail-value">{{ bottleneck_info.get('node_count', 0) }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Total Time:</span>
                <span class="detail-value">{{ '%.2f'|format(bottleneck_info.get('total_time_ms', 0)) }}ms</span>
            </div>
            {% if bottleneck_info.get('slowest_node') %}
            <div class="detail-row">
                <span class="detail-label">Slowest Node:</span>
                <span class="detail-value">{{ bottleneck_info.slowest_node.node_id }}
                    ({{ '%.2f'|format(bottleneck_info.slowest_node.avg_duration_ms) }}ms avg)</span>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if outputs %}
    <!-- Outputs Section -->
    <div class="table-container">
        <div class="table-header">
            <h2>Outputs</h2>
        </div>
        <pre class="json-output">{{ outputs | tojson(indent=2) }}</pre>
    </div>
    {% endif %}

    {% if state_history %}
    <!-- State History Section -->
    <div class="table-container">
        <div class="table-header">
            <h2>Execution History</h2>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Node</th>
                    <th>Timestamp</th>
                    <th>State Keys</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in state_history %}
                <tr>
                    <td class="monospace">{{ entry.node_id }}</td>
                    <td>{{ entry.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td class="monospace">{{ entry.state_data.keys() | list | join(', ') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block head %}
<style>
.details-content {
    padding: 1.5rem;
}

.detail-row {
    display: flex;
    padding: 0.75rem 0;
    border-bottom: 1px solid #e5e7eb;
}

.detail-row:last-child {
    border-bottom: none;
}

.detail-label {
    font-weight: 600;
    width: 150px;
    color: #6b7280;
    flex-shrink: 0;
}

.detail-value {
    color: #1f2937;
    flex: 1;
}

.error-message {
    color: #dc2626;
    background-color: #fee2e2;
    padding: 0.5rem;
    border-radius: 4px;
    display: inline-block;
}

.monospace {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.85rem;
}

.workflow-link {
    color: #3498db;
    text-decoration: none;
}

.workflow-link:hover {
    text-decoration: underline;
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
}

.json-output {
    padding: 1.5rem;
    margin: 0;
    background-color: #f8f9fa;
    border-radius: 0 0 8px 8px;
    overflow-x: auto;
    font-size: 0.85rem;
    max-height: 400px;
    overflow-y: auto;
}

.running-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #10b981;
    animation: pulse 1.5s ease-in-out infinite;
    margin-right: 0.5rem;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
        transform: scale(1);
    }
    50% {
        opacity: 0.5;
        transform: scale(1.2);
    }
}
</style>
{% endblock %}
