{% extends "base.html" %}

{% block head %}
<style>
.orchestrator-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.registration-form {
    background-color: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 30px;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #333;
}

.form-group input,
.form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.form-group textarea {
    min-height: 80px;
    resize: vertical;
}

.btn-register {
    background-color: #28a745;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.btn-register:hover {
    background-color: #218838;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    margin-left: 10px;
}

.btn-secondary:hover {
    background-color: #5a6268;
}

.agents-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

.agents-table th,
.agents-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.agents-table th {
    background-color: #f5f5f5;
    font-weight: 600;
}

.agents-table tr:hover {
    background-color: #f9f9f9;
}

.status-healthy {
    color: #28a745;
    font-weight: 600;
}

.status-unhealthy {
    color: #dc3545;
    font-weight: 600;
}

.btn-execute {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    margin-right: 5px;
}

.btn-execute:hover {
    background-color: #0056b3;
}

.btn-remove {
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
}

.btn-remove:hover {
    background-color: #c82333;
}

.error-message {
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
    padding: 12px;
    border-radius: 4px;
    margin-top: 15px;
}

.success-message {
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
    padding: 12px;
    border-radius: 4px;
    margin-top: 15px;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    padding: 20px;
    box-sizing: border-box;
}

.modal-content {
    background-color: white;
    max-width: 600px;
    margin: 100px auto;
    padding: 20px;
    border-radius: 8px;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.modal-header h2 {
    margin: 0;
}

.close-modal {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
}

.execute-form {
    margin-top: 20px;
}

.schema-field {
    margin-bottom: 15px;
}

.schema-field label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
}

.schema-field input,
.schema-field textarea,
.schema-field select {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.btn-submit {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    margin-top: 10px;
}

.btn-submit:hover {
    background-color: #0056b3;
}

.no-agents {
    text-align: center;
    padding: 40px;
    color: #6c757d;
}

.loading {
    text-align: center;
    padding: 20px;
    color: #6c757d;
}
</style>
{% endblock %}

{% block title %}Orchestrator - Configurable Agents Dashboard{% endblock %}

{% block nav_orchestrator %}class="active"{% endblock %}

{% block content %}
<div class="orchestrator-container">
    <div class="page-header">
        <h1>Orchestrator</h1>
        <p>Manage distributed agents and execute workflows on them</p>
    </div>

    <!-- Registration Form -->
    <div class="registration-form">
        <h2>Register New Agent</h2>
        <form hx-post="/orchestrator/register"
              hx-target="#registration-result"
              hx-swap="innerHTML">
            <div class="form-group">
                <label for="agent_id">Agent ID *</label>
                <input type="text"
                       id="agent_id"
                       name="agent_id"
                       placeholder="e.g., research-agent"
                       required>
            </div>

            <div class="form-group">
                <label for="agent_name">Agent Name *</label>
                <input type="text"
                       id="agent_name"
                       name="agent_name"
                       placeholder="e.g., Research Agent"
                       required>
            </div>

            <div class="form-group">
                <label for="agent_url">Agent URL *</label>
                <input type="url"
                       id="agent_url"
                       name="agent_url"
                       placeholder="e.g., http://localhost:8001"
                       required>
                <small style="color: #666;">Full URL including scheme (http:// or https://)</small>
            </div>

            <div class="form-group">
                <label for="metadata">Description (Optional)</label>
                <textarea id="metadata"
                          name="metadata"
                          placeholder="Optional description or metadata (JSON format)"></textarea>
            </div>

            <button type="submit" class="btn-register">Register Agent</button>
            <button type="button" class="btn-secondary" onclick="this.closest('form').reset()">Clear</button>
        </form>

        <div id="registration-result"></div>
    </div>

    <!-- Agents List -->
    <div id="agents-list-container"
         hx-get="/orchestrator/health-check"
         hx-trigger="load, every 10s"
         hx-swap="outerHTML">
        <div class="loading">Loading agents...</div>
    </div>
</div>

<!-- Execute Modal -->
<div id="execute-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-title">Execute Workflow</h2>
            <button class="close-modal" onclick="closeExecuteModal()">&times;</button>
        </div>

        <div id="modal-body">
            <div class="loading">Loading schema...</div>
        </div>
    </div>
</div>

<script>
let currentAgentId = null;
let currentAgentName = null;

function openExecuteModal(agentId, agentName) {
    currentAgentId = agentId;
    currentAgentName = agentName;

    document.getElementById('modal-title').textContent = `Execute on ${agentName}`;
    document.getElementById('execute-modal').style.display = 'block';

    // Load schema from agent
    loadAgentSchema(agentId);
}

function closeExecuteModal() {
    document.getElementById('execute-modal').style.display = 'none';
    currentAgentId = null;
    currentAgentName = null;
}

async function loadAgentSchema(agentId) {
    const modalBody = document.getElementById('modal-body');

    try {
        const response = await fetch(`/orchestrator/${agentId}/schema`);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const schema = await response.json();

        // Build form from schema
        let formHtml = `
            <form class="execute-form"
                  onsubmit="executeWorkflow(event, '${agentId}')">
                <p><strong>Workflow:</strong> ${schema.workflow || agentId}</p>
                <div id="execute-form-fields">
        `;

        if (schema.inputs) {
            for (const [fieldName, fieldDef] of Object.entries(schema.inputs)) {
                const required = fieldDef.required || false;
                const requiredAttr = required ? 'required' : '';
                const requiredLabel = required ? ' *' : '';

                formHtml += `
                    <div class="schema-field">
                        <label for="field-${fieldName}">${fieldName}${requiredLabel}</label>
                `;

                if (fieldDef.description) {
                    formHtml += `<small style="color: #666;">${fieldDef.description}</small><br>`;
                }

                // Simple text input for all fields (can be enhanced later)
                formHtml += `
                        <input type="text"
                               id="field-${fieldName}"
                               name="${fieldName}"
                               ${requiredAttr}>
                    </div>
                `;
            }
        } else {
            formHtml += `<p>No input fields defined for this workflow.</p>`;
        }

        formHtml += `
                </div>
                <button type="submit" class="btn-submit">Execute</button>
                <button type="button" class="btn-secondary" onclick="closeExecuteModal()">Cancel</button>
            </form>
        `;

        modalBody.innerHTML = formHtml;

    } catch (error) {
        modalBody.innerHTML = `
            <div class="error-message">
                Failed to load workflow schema: ${error.message}
            </div>
            <button class="btn-secondary" onclick="closeExecuteModal()" style="margin-top: 10px;">Close</button>
        `;
    }
}

async function executeWorkflow(event, agentId) {
    event.preventDefault();

    const form = event.target;
    const formData = new FormData(form);
    const inputs = {};

    for (const [key, value] of formData.entries()) {
        if (key.startsWith('field-')) {
            const fieldName = key.replace('field-', '');
            inputs[fieldName] = value;
        }
    }

    try {
        const response = await fetch(`/orchestrator/${agentId}/execute`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ inputs })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Execution failed');
        }

        const result = await response.json();

        // Redirect to run details page
        if (result.redirect_url) {
            window.location.href = result.redirect_url;
        }

    } catch (error) {
        alert(`Execution failed: ${error.message}`);
    }
}

function removeAgent(agentId, agentName) {
    if (!confirm(`Are you sure you want to remove agent "${agentName}" (${agentId})?`)) {
        return;
    }

    fetch(`/orchestrator/${agentId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'deregistered') {
            // Refresh the agents list
            const container = document.getElementById('agents-list-container');
            container.htmx.trigger('load');
        } else {
            alert(`Failed to remove agent: ${data.detail || 'Unknown error'}`);
        }
    })
    .catch(error => {
        alert(`Failed to remove agent: ${error.message}`);
    });
}

// Close modal on outside click
window.onclick = function(event) {
    const modal = document.getElementById('execute-modal');
    if (event.target === modal) {
        closeExecuteModal();
    }
}
</script>
{% endblock %}
