---
phase: 08-dashboard-ui-testing-and-fixes
plan: 02
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - src/configurable_agents/ui/dashboard/routes/agents.py
  - src/configurable_agents/ui/dashboard/templates/agents_table.html
  - src/configurable_agents/ui/dashboard/templates/agents.html
autonomous: true

must_haves:
  truths:
    - "Agents page loads without TemplateAssertionError"
    - "No underscore-prefixed functions imported in templates"
    - "Helper functions available via global context (not template imports)"
    - "agents_table.html uses macros from macros.html"
  artifacts:
    - path: "src/configurable_agents/ui/dashboard/routes/agents.py"
      provides: "Renamed helper functions without underscore prefix"
      exports: ["time_ago", "format_capabilities"]
    - path: "src/configurable_agents/ui/dashboard/templates/agents_table.html"
      contains: "No {% from ... import _time_ago %} statements"
  key_links:
    - from: "src/configurable_agents/ui/dashboard/app.py"
      to: "templates context"
      via: "time_ago, format_capabilities in template globals"
      pattern: "time_ago|format_capabilities"
    - from: "src/configurable_agents/ui/dashboard/templates/agents_table.html"
      to: "macros.html"
      via: "Uses shared macros instead of Python imports"
      pattern: "macros\\.status_badge"
---

<objective>
Fix Agents page Jinja2 import errors by renaming underscore-prefixed functions and removing template-level imports.

Purpose: Agents page crashes with `jinja2.exceptions.TemplateAssertionError: names starting with an underline can not be imported`. Template tries to import `_time_ago` and `_parse_capabilities` which violates Jinja2 rules.

Output: Working Agents page with functions renamed and available via global context.
</objective>

<execution_context>
@C:\Users\ghost\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\ghost\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-dashboard-ui-testing-and-fixes/08-CONTEXT.md
@.planning/UI_BUG_REPORT.md
@.planning/phases/08-dashboard-ui-testing-and-fixes/08-01-PLAN.md

# Current agents route code
@src/configurable_agents/ui/dashboard/routes/agents.py
@src/configurable_agents/ui/dashboard/templates/agents_table.html
@src/configurable_agents/ui/dashboard/app.py
</context>

<tasks>

<task type="auto">
  <name>Rename underscore functions in agents.py</name>
  <files>src/configurable_agents/ui/dashboard/routes/agents.py</files>
  <action>
    Rename functions by removing underscore prefix:
    - `_time_ago` → `time_ago`
    - `_format_datetime` → `format_datetime` (keep for internal use)
    - `_parse_capabilities` → `parse_capabilities`

    Update the `__all__` export list (lines 233-238):
    ```python
    __all__ = [
        "router",
        "time_ago",  # was _time_ago
        "format_datetime",  # was _format_datetime
        "parse_capabilities",  # was _parse_capabilities
    ]
    ```

    Update function definitions (rename functions, keep docstrings):
    - Line 24: `def _time_ago(` → `def time_ago(`
    - Line 54: `def _format_datetime(` → `def format_datetime(`
    - Line 68: `def _parse_capabilities(` → `def parse_capabilities(`

    No internal logic changes needed - these are pure function renames.
  </action>
  <verify>
    agents.py exports time_ago, format_capabilities (no underscore prefix)
  </verify>
  <done>
    agents.py has time_ago, format_capabilities functions exported in __all__
  </done>
</task>

<task type="auto">
  <name>Register helper functions in app.py template globals</name>
  <files>src/configurable_agents/ui/dashboard/app.py</files>
  <action>
    Update the template globals registration in `DashboardApp.__init__` to use renamed functions.

    Find the globals.update section added in 08-01 (after `_include_routers()`), and update to use renamed functions:

    ```python
    # After _include_routers(), register actual helper functions
    from configurable_agents.ui.dashboard.routes.agents import (
        time_ago,  # renamed from _time_ago in Task 1 of this plan
        parse_capabilities  # renamed from _parse_capabilities in Task 1 of this plan
    )
    from configurable_agents.ui.dashboard.routes.workflows import (
        _format_duration as fmt_dur_impl,
        _format_cost as fmt_cost_impl
    )

    self.templates.env.globals.update({
        "format_duration": fmt_dur_impl,
        "format_cost": fmt_cost_impl,
        "time_ago": time_ago,
        "parse_capabilities": parse_capabilities,
    })
    ```

    Verify the functions are callable by checking `self.templates.env.globals["time_ago"]` returns a callable after initialization.
  </action>
  <verify>
    app.py imports time_ago, parse_capabilities from routes.agents and registers in template globals
  </verify>
  <done>
    Template context includes time_ago and parse_capabilities functions callable from templates
  </done>
</task>

<task type="auto">
  <name>Remove Python imports from agents_table.html</name>
  <files>src/configurable_agents/ui/dashboard/templates/agents_table.html</files>
  <action>
    Remove line 1 entirely:
    `{% from 'configurable_agents.ui.dashboard.routes.agents' import _time_ago, _parse_capabilities %}`

    Replace template function calls with global context access:
    - Line 22: `{% set capabilities = _parse_capabilities(agent.agent_metadata) %}`
      → `{% set capabilities = parse_capabilities(agent.agent_metadata) %}`

    - Line 34: `{{ _time_ago(agent.last_heartbeat) }}`
      → `{{ time_ago(agent.last_heartbeat) }}`

    Or use macros if available from 08-01: `{{ macros.time_ago(agent.last_heartbeat) }}`
  </action>
  <verify>
    agents_table.html has no {% from ... import _* statements
  </verify>
  <done>
    agents_table.html uses global context functions, no Python module imports
  </done>
</task>

</tasks>

<verification>
1. Start dashboard: `configurable-agents ui --dashboard-port-only 7861`
2. Visit http://localhost:7861/agents
3. Verify page loads without TemplateAssertionError
4. Verify agents table displays with time-ago formatting and capabilities parsed
</verification>

<success_criteria>
- Agents page loads without errors
- No underscore-prefixed imports in templates
- Time ago formatting works correctly
- Capabilities parsing and display works
</success_criteria>

<output>
After completion, create `.planning/phases/08-dashboard-ui-testing-and-fixes/08-02-SUMMARY.md`
</output>
