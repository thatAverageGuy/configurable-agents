---
phase: 08-dashboard-ui-testing-and-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/configurable_agents/ui/dashboard/templates/macros.html
  - src/configurable_agents/ui/dashboard/app.py
  - src/configurable_agents/ui/dashboard/templates/workflows_table.html
  - src/configurable_agents/ui/dashboard/templates/agents_table.html
autonomous: true

must_haves:
  truths:
    - "Workflows page loads without TemplateNotFound error"
    - "Agents page can use macros without importing from Python modules"
    - "All templates share common status badge and formatting macros"
    - "Helper functions available globally via context processor"
  artifacts:
    - path: "src/configurable_agents/ui/dashboard/templates/macros.html"
      provides: "Shared Jinja2 macros for status badges, duration, cost formatting"
      min_lines: 30
    - path: "src/configurable_agents/ui/dashboard/app.py"
      provides: "Global context processor with helper functions"
      contains: "def _add_template_context"
  key_links:
    - from: "src/configurable_agents/ui/dashboard/templates/workflows_table.html"
      to: "src/configurable_agents/ui/dashboard/templates/macros.html"
      via: "{% import 'macros.html' as macros %}"
      pattern: "{% import.*macros"
    - from: "src/configurable_agents/ui/dashboard/app.py"
      to: "templates.TemplateResponse"
      via: "context processor adds helper functions to template context"
      pattern: "context|_add_template_context"
---

<objective>
Fix Workflows page template errors by creating shared macros.html and global context processor.

Purpose: Workflows page crashes with `jinja2.exceptions.TemplateNotFound: 'macros.html'`. Need to create missing macros file and provide helper functions via context processor instead of Python module imports.

Output: Working Workflows and Agents pages with shared macros and global helper functions.
</objective>

<execution_context>
@C:\Users\ghost\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\ghost\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-dashboard-ui-testing-and-fixes/08-CONTEXT.md
@.planning/UI_BUG_REPORT.md

# Current template and route code
@src/configurable_agents/ui/dashboard/templates/workflows_table.html
@src/configurable_agents/ui/dashboard/templates/agents_table.html
@src/configurable_agents/ui/dashboard/routes/agents.py
@src/configurable_agents/ui/dashboard/routes/workflows.py
@src/configurable_agents/ui/dashboard/app.py
</context>

<tasks>

<task type="auto">
  <name>Create macros.html with shared template macros</name>
  <files>src/configurable_agents/ui/dashboard/templates/macros.html</files>
  <action>
    Create new file `src/configurable_agents/ui/dashboard/templates/macros.html` with:

    1. **status_badge macro** - Renders status with appropriate CSS class:
       - Input: status string, optional css_class override
       - Output: span.badge with status and CSS class
       - Statuses: running, completed, failed, pending, cancelled

    2. **format_duration macro** - Formats seconds as human readable:
       - Input: seconds (float or None)
       - Output: "Xm Ys", "Ys", "< 1s", or "-"

    3. **format_cost macro** - Formats USD value:
       - Input: usd (float or None)
       - Output: "$X.XXXX" or "$0.00"

    4. **time_ago macro** - Formats datetime as relative time:
       - Input: datetime object
       - Output: "just now", "Xm ago", "Xh ago", "Xd ago", or "-"

    Use Jinja macro syntax: `{% macro name(args) %}...{% endmacro %}`
  </action>
  <verify>
    File exists with at least 4 macros defined. Run: `ls -la src/configurable_agents/ui/dashboard/templates/macros.html`
  </verify>
  <done>
    macros.html exists with status_badge, format_duration, format_cost, time_ago macros
  </done>
</task>

<task type="auto">
  <name>Add global context processor to app.py</name>
  <files>src/configurable_agents/ui/dashboard/app.py</files>
  <action>
    In `_setup_templates()` method, after line 126 (after filters), add template globals:

    ```python
    # Add helper functions to template globals
    # Stub functions for now - actual implementations registered after router loading
    self.templates.env.globals.update({
        "format_duration": lambda s: "-",
        "format_cost": lambda c: "$0.00",
        "time_ago": lambda dt: "-",
        "parse_capabilities": lambda m: [],
    })
    ```

    Then in `DashboardApp.__init__`, after `_include_routers()` call (where modules are loaded), update globals with actual implementations:

    ```python
    # After _include_routers(), register actual helper functions
    from configurable_agents.ui.dashboard.routes.agents import (
        _time_ago as time_ago_impl, _parse_capabilities as parse_caps_impl
    )
    from configurable_agents.ui.dashboard.routes.workflows import (
        _format_duration as fmt_dur_impl, _format_cost as fmt_cost_impl
    )

    self.templates.env.globals.update({
        "format_duration": fmt_dur_impl,
        "format_cost": fmt_cost_impl,
        "time_ago": time_ago_impl,
        "parse_capabilities": parse_caps_impl,
    })
    ```
  </action>
  <verify>
    app.py has template globals with format_duration, format_cost, time_ago, parse_capabilities
  </verify>
  <done>
    Templates have access to format_duration, format_cost, time_ago, parse_capabilities globally
  </done>
</task>

<task type="auto">
  <name>Update workflows_table.html to use macros</name>
  <files>src/configurable_agents/ui/dashboard/templates/workflows_table.html</files>
  <action>
    Keep the `{% import "macros.html" as macros %}` at top.

    Replace inline status badge logic (lines 26-33) with:
    `{% set status_class = macros.status_badge_class(workflow.status) %}`

    Or better: Replace entire badge rendering with `{{ macros.status_badge(workflow.status) }}`

    Replace duration formatting (lines 36-45) with `{{ macros.format_duration(workflow.duration_seconds) }}`

    Replace cost formatting (line 48) with `{{ macros.format_cost(workflow.total_cost_usd) }}`

    Keep the rest of the table structure intact.
  </action>
  <verify>
    workflows_table.html uses macros.status_badge, macros.format_duration, macros.format_cost
  </verify>
  <done>
    workflows_table.html imports and uses macros from macros.html
  </done>
</task>

</tasks>

<verification>
1. Start dashboard: `configurable-agents ui --dashboard-port-only 7861`
2. Visit http://localhost:7861/workflows
3. Verify page loads without TemplateNotFound error
4. Verify table renders with proper status badges, durations, costs
</verification>

<success_criteria>
- Workflows page loads without errors
- Status badges display with correct CSS classes
- Durations and costs formatted properly
- No TemplateNotFound errors in logs
</success_criteria>

<output>
After completion, create `.planning/phases/08-dashboard-ui-testing-and-fixes/08-01-SUMMARY.md`
</output>
