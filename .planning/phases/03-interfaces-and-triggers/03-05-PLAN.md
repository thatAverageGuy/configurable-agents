---
phase: 03-interfaces-and-triggers
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/storage/test_chat_session_repository.py
  - tests/storage/test_factory.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "All test fixtures unpack correct number of values from create_storage_backend()"
    - "pytest tests/storage/test_chat_session_repository.py passes"
    - "pytest tests/storage/test_factory.py passes"
  artifacts:
    - path: tests/storage/test_chat_session_repository.py
      provides: "ChatSessionRepository test suite"
      contains: "6-tuple unpacking from create_storage_backend"
    - path: tests/storage/test_factory.py
      provides: "Factory function test suite"
      contains: "6-tuple unpacking from create_storage_backend"
  key_links:
    - from: "tests/storage/test_chat_session_repository.py"
      to: "src/configurable_agents/storage/factory.py"
      via: "create_storage_backend() fixture"
      pattern: "workflow_repo, state_repo, agent_repo, cost_repo, chat_repo, webhook_repo"
    - from: "tests/storage/test_factory.py"
      to: "src/configurable_agents/storage/factory.py"
      via: "create_storage_backend() direct calls"
      pattern: "workflow_repo, state_repo, agent_repo, cost_repo, chat_repo, webhook_repo"
---

<objective>
Fix test fixture unpacking to match the 6-tuple return from create_storage_backend().

Purpose: In plan 03-03, create_storage_backend() was updated to return 6 values (added webhook_repo).
Existing tests still unpack 4 or 2 values, causing ValueError during test runs.

This is a test-only fix - the implementation is already correct.

Output: All storage tests pass with correct unpacking count.
</objective>

<execution_context>
@C:\Users\ghost\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\ghost\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-interfaces-and-triggers/03-VERIFICATION.md
@.planning/phases/03-interfaces-and-triggers/03-03-SUMMARY.md

@src/configurable_agents/storage/factory.py
@tests/storage/test_chat_session_repository.py
@tests/storage/test_factory.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update test_chat_session_repository.py fixture to unpack 6 values</name>
  <files>tests/storage/test_chat_session_repository.py</files>
  <action>
    Update the chat_repo fixture (lines 20-24) to unpack all 6 values from create_storage_backend():

    Current (WRONG - unpacks 4):
    ```python
    @pytest.fixture
    def chat_repo():
        _, _, _, chat_repo = create_storage_backend()
        return chat_repo
    ```

    Change to (CORRECT - unpacks 6):
    ```python
    @pytest.fixture
    def chat_repo():
        workflow_repo, state_repo, agent_repo, cost_repo, chat_repo, webhook_repo = create_storage_backend()
        return chat_repo
    ```

    Note: cost_repo is the 4th return value (AgentCostTrackingRepository). The variable name uses cost_repo for clarity.
  </action>
  <verify>
    Run: pytest tests/storage/test_chat_session_repository.py -v

    Expected: All 14 tests pass
  </verify>
  <done>
    - chat_repo fixture unpacks all 6 values from create_storage_backend()
    - No ValueError during fixture initialization
    - All 14 tests in test_chat_session_repository.py pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Update test_factory.py to unpack 6 values from create_storage_backend()</name>
  <files>tests/storage/test_factory.py</files>
  <action>
    Update all test methods in test_factory.py to unpack 6 values instead of 2.

    Current pattern (WRONG - unpacks 2):
    ```python
    runs_repo, states_repo = create_storage_backend()
    ```

    Change to (CORRECT - unpacks 6):
    ```python
    runs_repo, states_repo, agents_repo, chat_repo, webhook_repo, cost_repo = create_storage_backend()
    ```

    Update lines 28, 42, 56, 81:
    - test_default_config_creates_sqlite_repos (line 28)
    - test_explicit_sqlite_config_creates_repos (line 42)
    - test_factory_creates_tables_automatically (line 56)
    - test_connection_string_style_sqlite_backend (line 81)

    Note: Order from factory return is:
    1. workflow_run_repository
    2. execution_state_repository
    3. agent_registry_repository
    4. chat_session_repository
    5. webhook_event_repository
    6. agent_cost_tracking_repository (added in phase 02)
  </action>
  <verify>
    Run: pytest tests/storage/test_factory.py -v

    Expected: All 5 tests pass
  </verify>
  <done>
    - All test methods unpack 6 values from create_storage_backend()
    - No ValueError during test execution
    - All 5 tests in test_factory.py pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Run full storage test suite to verify no other unpacking issues</name>
  <files>tests/storage/</files>
  <action>
    Run the complete storage test suite to ensure no other test files have unpacking issues:

    1. Run: pytest tests/storage/ -v
    2. Check for any ValueError exceptions about too many values to unpack
    3. If found, update those files with same 6-tuple unpacking pattern
    4. Re-run until all tests pass

    The expected return order is:
    workflow_repo, state_repo, agent_repo, chat_repo, webhook_repo, cost_repo
  </action>
  <verify>
    Run: pytest tests/storage/ -v

    Expected: All storage tests pass (>60 tests total)
  </verify>
  <done>
    - All storage tests pass with correct unpacking
    - No remaining ValueError: too many values to unpack errors
    - Test coverage for chat session persistence verified
  </done>
</task>

</tasks>

<verification>
After all tasks:

1. Run pytest tests/storage/test_chat_session_repository.py -v (14 tests pass)
2. Run pytest tests/storage/test_factory.py -v (5 tests pass)
3. Run pytest tests/storage/ -v (all storage tests pass)
4. Verify chat session persistence tests cover:
   - Session creation and retrieval
   - Message storage and ordering
   - Config update and persistence
   - Recent session listing
   - Concurrent access
</verification>

<success_criteria>
1. All 14 tests in test_chat_session_repository.py pass
2. All 5 tests in test_factory.py pass
3. Full storage test suite passes without unpacking errors
4. No test file uses 2-tuple or 4-tuple unpacking from create_storage_backend()
</success_criteria>

<output>
After completion, create `.planning/phases/03-interfaces-and-triggers/03-05-SUMMARY.md`
</output>
