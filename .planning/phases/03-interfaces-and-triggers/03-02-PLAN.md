---
phase: 03-interfaces-and-triggers
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/configurable_agents/ui/dashboard/__init__.py
  - src/configurable_agents/ui/dashboard/app.py
  - src/configurable_agents/ui/dashboard/routes/__init__.py
  - src/configurable_agents/ui/dashboard/routes/workflows.py
  - src/configurable_agents/ui/dashboard/routes/agents.py
  - src/configurable_agents/ui/dashboard/routes/metrics.py
  - src/configurable_agents/ui/dashboard/templates/base.html
  - src/configurable_agents/ui/dashboard/templates/dashboard.html
  - src/configurable_agents/ui/dashboard/templates/workflows.html
  - src/configurable_agents/ui/dashboard/templates/agents.html
  - src/configurable_agents/ui/dashboard/static/dashboard.css
  - tests/ui/test_dashboard.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can view all running workflows, their status, logs, and metrics on the orchestration dashboard"
    - "User can stop or restart a workflow from the UI"
    - "User can see registered agents, their capabilities, and health status in the orchestration dashboard"
    - "Dashboard auto-refreshes to show real-time status updates"
    - "MLFlow UI is embedded within the orchestration dashboard via iframe"
  artifacts:
    - path: "src/configurable_agents/ui/dashboard/app.py"
      provides: "FastAPI dashboard application"
      min_lines: 80
    - path: "src/configurable_agents/ui/dashboard/routes/workflows.py"
      provides: "Workflow list, details, status endpoints"
      exports: ["router as workflows_router"]
    - path: "src/configurable_agents/ui/dashboard/routes/agents.py"
      provides: "Agent discovery and health status endpoints"
      exports: ["router as agents_router"]
    - path: "src/configurable_agents/ui/dashboard/routes/metrics.py"
      provides: "SSE endpoint for real-time metrics"
      exports: ["router as metrics_router"]
    - path: "src/configurable_agents/ui/dashboard/templates/base.html"
      provides: "Base template with HTMX CDN and SSE extension"
      contains: "htmx.org", "sse.js"
    - path: "src/configurable_agents/ui/dashboard/templates/dashboard.html"
      provides: "Main dashboard view"
      contains: "workflow", "agent", "metric"
    - path: "src/configurable_agents/ui/dashboard/templates/workflows.html"
      provides: "Workflow list table with HTMX auto-refresh"
      contains: "hx-trigger", "workflows/table"
    - path: "src/configurable_agents/ui/dashboard/templates/agents.html"
      provides: "Agent registry table with health indicators"
      contains: "is_alive", "agent"
  key_links:
    - from: "src/configurable_agents/ui/dashboard/routes/workflows.py"
      to: "src/configurable_agents/storage"
      via: "WorkflowRunRepository for workflow data"
      pattern: "WorkflowRunRepository"
    - from: "src/configurable_agents/ui/dashboard/routes/agents.py"
      to: "src/configurable_agents/storage"
      via: "AgentRegistryRepository for agent discovery"
      pattern: "AgentRegistryRepository"
    - from: "src/configurable_agents/ui/dashboard/templates/workflows.html"
      to: "/workflows/stream"
      via: "HTMX SSE connection for real-time updates"
      pattern: "sse-connect"
    - from: "src/configurable_agents/ui/dashboard/app.py"
      to: "mlflow.server.app"
      via: "WSGIMiddleware for MLFlow UI mount"
      pattern: "WSGIMiddleware"
---

<objective>
Build a FastAPI + HTMX orchestration dashboard for real-time workflow monitoring, agent discovery, and MLFlow UI embedding, enabling users to manage running workflows and view registered agents without page refreshes.

Purpose: Provide a unified view of the entire system - running workflows with status/metrics, registered agents with health indicators, and embedded MLFlow observability - using server-side rendering with HTMX for dynamic updates without JavaScript frameworks.

Output: Dashboard server on port 7861 with workflow monitoring, agent discovery, real-time SSE updates, and embedded MLFlow UI
</object>

<execution_context>
@C:\Users\ghost\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\ghost\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-interfaces-and-triggers/03-RESEARCH.md
@.planning/phases/02-agent-infrastructure/02-01A-SUMMARY.md
@.planning/phases/02-agent-infrastructure/02-02A-SUMMARY.md

@src/configurable_agents/storage/models.py
@src/configurable_agents/storage/base.py
@src/configurable_agents/runtime/executor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dashboard FastAPI application and base templates</name>
  <files>src/configurable_agents/ui/dashboard/__init__.py, src/configurable_agents/ui/dashboard/app.py, src/configurable_agents/ui/dashboard/templates/base.html, src/configurable_agents/ui/dashboard/templates/dashboard.html, src/configurable_agents/ui/dashboard/static/dashboard.css</files>
  <action>
    Create the FastAPI dashboard application with Jinja2 templates:

    1. **Create dashboard package structure:**
       - src/configurable_agents/ui/dashboard/__init__.py: Exports for DashboardApp, create_dashboard_app()

    2. **Create app.py with DashboardApp class:**
       - __init__(workflow_repo, agent_registry_repo, mlflow_tracking_uri: str = None): Initialize with repositories and optional MLFlow URI
       - app: FastAPI instance with title "Configurable Agents Dashboard"
       - _setup_templates(): Configure Jinja2Templates with templates directory
       - _setup_static_files(): Mount static files directory at /static
       - _mount_mlflow(mlflow_tracking_uri): Mount MLFlow WSGI app at /mlflow using WSGIMiddleware (if URI provided)
       - create_main_dashboard_routes(): GET / endpoint rendering dashboard.html
       - get_app(): Return FastAPI instance for external mounting

    3. **Create base.html template:**
       - HTML5 structure with HTMX CDN (https://unpkg.com/htmx.org@1.9.10)
       - HTMX SSE extension (https://unpkg.com/htmx.org/dist/ext/sse.js)
       - CSS link to /static/dashboard.css
       - Navigation bar with links: / (Dashboard), /workflows (Workflows), /agents (Agents), /mlflow (MLFlow)
       - Main content block ({% block content %}{% endblock %})
       - Custom JavaScript for SSE reconnection on error

    4. **Create dashboard.html template:**
       - Extends base.html
       - Summary cards: Total Workflows, Running Workflows, Registered Agents, Total Cost
       - Quick links to detailed views
       - HTMX auto-refresh for summary cards (every 10s)

    5. **Create dashboard.css:**
       - Modern, clean styling without frameworks
       - Responsive grid layout
       - Status badges (running=green, completed=blue, failed=red)
       - Agent health indicators (alive=green dot, expired=red dot)
       - Table styles for workflows and agents lists

    Reference research: .planning/phases/03-interfaces-and-triggers/03-RESEARCH.md lines 232-466
    Use existing FastAPI patterns from registry/server.py (02-01A-SUMMARY)
  </action>
  <verify>
    from configurable_agents.ui.dashboard import create_dashboard_app
    from configurable_agents.storage import create_storage_backend

    workflow_repo, state_repo, agent_repo, cost_repo, chat_repo = create_storage_backend(None)
    app = create_dashboard_app(workflow_repo, agent_repo)

    # Verify routes exist
    routes = [route.path for route in app.routes]
    assert "/" in routes
    assert "/static" in routes
    # Verify MLFlow mount (if URI provided)
    assert any("/mlflow" in route.path for route in app.routes)
  </verify>
  <done>
    DashboardApp class created with FastAPI application
    Jinja2 templates configured with base.html and dashboard.html
    Static CSS file with dashboard styles
    MLFlow WSGI mount at /mlflow (when URI provided)
    Navigation and summary cards rendering
  </done>
</task>

<task type="auto">
  <name>Task 2: Create workflow monitoring routes and templates</name>
  <files>src/configurable_agents/ui/dashboard/routes/__init__.py, src/configurable_agents/ui/dashboard/routes/workflows.py, src/configurable_agents/ui/dashboard/templates/workflows.html</files>
  <action>
    Create workflow monitoring routes with HTMX-powered real-time updates:

    1. **Create routes package:**
       - src/configurable_agents/ui/dashboard/routes/__init__.py: Export routers

    2. **Create workflows.py router:**
       - router = APIRouter(prefix="/workflows")
       - Templates initialized with Jinja2Templates

       - GET /: Render workflows.html with active runs
       - GET /table: Return workflows_table.html partial for HTMX refresh (hx-trigger="load, every 5s")
       - GET /{run_id}: Render workflow detail page with state history
       - POST /{run_id}/cancel: Attempt to cancel running workflow (best-effort, updates status to "cancelled")
       - POST /{run_id}/restart: Re-run workflow with same inputs

       Helper functions:
       - _format_duration(seconds: float) -> str: Format as "Xm Ys"
       - _format_cost(usd: float) -> str: Format as "$X.XXXX"
       - _format_datetime(dt: datetime) -> str: Format as "YYYY-MM-DD HH:MM:SS"

    3. **Create workflows.html template:**
       - Extends base.html
       - Page title "Workflows"
       - Filters: Status (all/running/completed/failed), Time range (today/week/all)
       - Workflow table with columns: ID, Name, Status, Started, Duration, Tokens, Cost, Actions
       - Table wrapped in <div> with hx-get="/workflows/table" hx-swap="outerHTML" hx-trigger="load, every 5s"
       - Status badges with color coding
       - Action buttons: View, Cancel (if running), Restart
       - SSE connection for real-time updates: <div hx-ext="sse" sse-connect="/workflows/stream" sse-swap="message">

    4. **Create partial template workflows_table.html:**
       - Same table structure without page wrapper
       - Used for HTMX partial updates

    Reference research: .planning/phases/03-interfaces-and-triggers/03-RESEARCH.md lines 310-414
    Use WorkflowRunRepository from storage for data access
    Use existing WorkflowRunRecord model (01-01A, 02-02A)
  </action>
  <verify>
    # Test router creation
    from configurable_agents.ui.dashboard.routes.workflows import router as workflows_router

    routes = [route.path for route in workflows_router.routes]
    assert "/workflows" in routes
    assert "/workflows/table" in routes
    assert "/workflows/{run_id}" in routes
  </verify>
  <done>
    Workflows router with all CRUD endpoints
    Workflows table with HTMX auto-refresh (5s interval)
    Status badges with color coding
    Action buttons for view/cancel/restart
    Partial template for HTMX swaps
  </done>
</task>

<task type="auto">
  <name>Task 3: Create agent discovery routes and metrics SSE endpoint</name>
  <files>src/configurable_agents/ui/dashboard/routes/agents.py, src/configurable_agents/ui/dashboard/routes/metrics.py, src/configurable_agents/ui/dashboard/templates/agents.html</files>
  <action>
    Create agent discovery routes and SSE metrics streaming:

    1. **Create agents.py router:**
       - router = APIRouter(prefix="/agents")
       - GET /: Render agents.html with registered agents
       - GET /table: Return agents_table.html partial for HTMX refresh (hx-trigger="load, every 10s")
       - DELETE /{agent_id}: Deregister agent from registry
       - GET /{agent_id}/docs: Redirect to agent's API docs (http://{host}:{port}/docs)

       Helper functions:
       - _time_ago(dt: datetime) -> str: Format as "just now", "Xm ago", "Xh ago", "Xd ago"
       - _parse_capabilities(agent_metadata: str) -> List[str]: Extract capabilities from JSON metadata

    2. **Create agents.html template:**
       - Extends base.html
       - Page title "Registered Agents"
       - Refresh button with hx-post="/agents/refresh"
       - Agent table with columns: ID, Name, Host:Port, Capabilities, Last Heartbeat, Status, Actions
       - Table wrapped in <div> with hx-get="/agents/table" hx-swap="outerHTML" hx-trigger="load, every 10s"
       - Status dots: green for alive (is_alive()=True), red for expired
       - Capabilities displayed as badges
       - Actions: API Docs (opens in new tab), Deregister (hx-delete)
       - Empty state message when no agents registered

    3. **Create partial template agents_table.html:**
       - Same table structure without page wrapper

    4. **Create metrics.py router with SSE streaming:**
       - router = APIRouter(prefix="/metrics")
       - GET /workflows/stream: SSE endpoint for workflow updates
         * Yields "event: workflow_update\n" with JSON data array of active runs
         * Yields heartbeat every 5 seconds to keep connection alive
         * Headers: Cache-Control: no-cache, Connection: keep-alive, X-Accel-Buffering: no

       - GET /agents/stream: SSE endpoint for agent updates
         * Yields "event: agent_update\n" with JSON data array of agents
         * Yields heartbeat every 10 seconds

    Reference research: .planning/phases/03-interfaces-and-triggers/03-RESEARCH.md lines 365-414, 766-884
    Use AgentRegistryRepository from storage for agent data
    Use existing AgentRecord model with is_alive() method (02-01A-SUMMARY)
  </action>
  <verify>
    # Test routers creation
    from configurable_agents.ui.dashboard.routes.agents import router as agents_router
    from configurable_agents.ui.dashboard.routes.metrics import router as metrics_router

    agent_routes = [route.path for route in agents_router.routes]
    assert "/agents" in agent_routes
    assert "/agents/table" in agent_routes

    metric_routes = [route.path for route in metrics_router.routes]
    assert "/metrics/workflows/stream" in metric_routes
    assert "/metrics/agents/stream" in metric_routes
  </verify>
  <done>
    Agents router with list/table/deregister endpoints
    Agents table with HTMX auto-refresh (10s interval)
    Health status dots (green/red) based on is_alive()
    Capabilities displayed as badges from agent_metadata JSON
    SSE streaming endpoints for workflows and agents
    Heartbeat messages to keep SSE connections alive
  </done>
</task>

<task type="auto">
  <name>Task 4: Wire up routes and add dashboard tests</name>
  <files>src/configurable_agents/ui/dashboard/app.py, tests/ui/test_dashboard.py</files>
  <action>
    Integrate all routers into main app and create tests:

    1. **Update app.py:**
       - Import all routers: from .routes import workflows, agents, metrics
       - In __init__: self.app.include_router(workflows.router), self.app.include_router(agents.router), self.app.include_router(metrics.router)
       - Update SSE endpoints in templates to use /metrics/workflows/stream and /metrics/agents/stream

    2. **Update templates for SSE:**
       - workflows.html: Change sse-connect to "/metrics/workflows/stream"
       - agents.html: Add SSE connection for agent updates

    3. **Create tests/ui/test_dashboard.py:**
       - test_dashboard_app_creation: Verify app initializes with repositories
       - test_routes_registered: Verify all routes registered
       - test_mlflow_mounted: Verify MLFlow mounted at /mlflow
       - test_workflows_list: Test GET /workflows returns HTML
       - test_agents_list: Test GET /agents returns HTML
       - test_workflows_stream: Test SSE endpoint returns text/event-stream
       - test_time_ago_helper: Test time formatting helper
       - test_format_duration_helper: Test duration formatting

       Use httpx.AsyncClient for testing (matching 02-01C-SUMMARY patterns)
       Mock repositories with fake data for isolated tests

    4. **Add CLI command for launching dashboard:**
       - Add @click.command() for "configurable-agents dashboard" CLI
       - Options: --host (default: 0.0.0.0), --port (default: 7861), --mlflow-uri (optional)
       - Create storage backend and dashboard app
       - Launch with uvicorn.run(app, host=host, port=port)

    Reference research: .planning/phases/03-interfaces-and-triggers/03-RESEARCH.md lines 443-487
    Use existing CLI patterns from CLI commands in Phase 2
  </action>
  <verify>
    pytest tests/ui/test_dashboard.py -v
    # All tests pass

    # Test CLI launch
    configurable-agents dashboard --help
    # Shows help with --host, --port, --mlflow-uri options

    # Test server launch
    configurable-agents dashboard --port 7861 &
    curl http://localhost:7861/
    # Returns HTML with dashboard content
  </verify>
  <done>
    All routers integrated into main dashboard app
    SSE endpoints connected to templates
    Dashboard tests passing with >80% coverage
    CLI command "configurable-agents dashboard" working
    Server launches on port 7861
  </done>
</task>

</tasks>

<verification>
After completing all tasks, verify:

1. **Dashboard tests pass:**
   ```bash
   pytest tests/ui/test_dashboard.py -v
   ```

2. **Import verification:**
   ```bash
   python -c "from configurable_agents.ui.dashboard import create_dashboard_app; print('OK')"
   ```

3. **CLI help:**
   ```bash
   configurable-agents dashboard --help
   ```

4. **Manual verification (checkpoint):**
   - Launch dashboard: `configurable-agents dashboard --port 7861`
   - Visit http://localhost:7861
   - Verify dashboard loads with summary cards
   - Navigate to /workflows - verify table shows workflow runs
   - Navigate to /agents - verify table shows registered agents
   - Navigate to /mlflow - verify MLFlow UI embedded
   - Wait 10 seconds - verify agent table auto-refreshes
   - Wait 5 seconds - verify workflow table auto-refreshes
</verification>

<success_criteria>
1. Dashboard launches on port 7861 via CLI
2. Main dashboard shows summary cards (workflows, agents, cost)
3. Workflows page shows table with status/duration/cost columns
4. Workflow table auto-refreshes every 5 seconds
5. Agents page shows table with health status dots
6. Agent table auto-refreshes every 10 seconds
7. MLFlow UI accessible at /mlflow within dashboard
8. SSE connections maintain and auto-reconnect on error
9. Cancel/restart buttons work for workflows
10. Deregister button works for agents
11. All tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/03-interfaces-and-triggers/03-02-SUMMARY.md`
</output>
