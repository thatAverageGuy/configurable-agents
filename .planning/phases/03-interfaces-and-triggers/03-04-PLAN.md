---
phase: 03-interfaces-and-triggers
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/configurable_agents/ui/dashboard/routes/workflows.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can restart a completed/failed workflow from dashboard UI"
    - "Restart creates new workflow run with original inputs"
    - "Restart returns 200 status with new run_id"
  artifacts:
    - path: src/configurable_agents/ui/dashboard/routes/workflows.py
      provides: "workflow_restart endpoint implementation"
      contains: "run_workflow_async"
  key_links:
    - from: "src/configurable_agents/ui/dashboard/routes/workflows.py"
      to: "configurable_agents.runtime.executor.run_workflow_async"
      via: "async import and background task execution"
      pattern: "run_workflow_async"
---

<objective>
Implement workflow restart functionality in the dashboard UI to close the UI-04 requirement gap.

Purpose: The workflow_restart endpoint currently returns 501 "coming soon" placeholder. This plan implements actual restart functionality by:
1. Extracting the original config_path from the workflow run record
2. Parsing original inputs from the run record
3. Re-executing the workflow via run_workflow_async()
4. Returning 200 with the new run_id

Output: Users can restart workflows directly from the dashboard UI without CLI access.
</objective>

<execution_context>
@C:\Users\ghost\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\ghost\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-interfaces-and-triggers/03-VERIFICATION.md
@.planning/phases/03-interfaces-and-triggers/03-02-SUMMARY.md
@.planning/phases/03-interfaces-and-triggers/03-03-SUMMARY.md

@src/configurable_agents/ui/dashboard/routes/workflows.py
@src/configurable_agents/runtime/executor.py
@src/configurable_agents/storage/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement workflow_restart endpoint with executor integration</name>
  <files>src/configurable_agents/ui/dashboard/routes/workflows.py</files>
  <action>
    Replace the placeholder workflow_restart function (lines 273-302) with actual implementation:

    1. Import run_workflow_async from configurable_agents.runtime.executor
    2. Import BackgroundTasks from fastapi
    3. Update function signature to accept BackgroundTasks parameter
    4. Get the original run from workflow_repo
    5. Return 404 if run not found
    6. Extract config_path from run.config_snapshot (parse JSON, find or infer config path)
    7. Parse original inputs from run.inputs (JSON parse)
    8. Execute workflow via run_workflow_async(config_path, inputs)
    9. Return 200 with response containing new run_id and status "restarted"

    Important implementation notes:
    - config_snapshot contains the full config as JSON, not a file path
    - To restart, save config_snapshot to temp file and run_workflow_async() on temp file
    - Use tempfile.NamedTemporaryFile with mode='w', suffix='.yaml', delete=False
    - Parse JSON config_snapshot, write YAML to temp file using yaml.dump()
    - Run workflow via run_workflow_async(temp_file_path, inputs)
    - Clean up temp file after execution with os.unlink()

    Error handling:
    - Return 400 if workflow is currently running (cannot restart running workflow)
    - Return 500 if workflow execution fails, include error message
  </action>
  <verify>
    Run tests:
    pytest tests/ui/test_dashboard.py -v -k "restart"

    Manual test via curl:
    curl -X POST http://localhost:7861/workflows/{run_id}/restart

    Expected: 200 status with JSON response containing new run_id
  </verify>
  <done>
    - workflow_restart endpoint executes workflows via run_workflow_async()
    - Restarted workflow uses original inputs from stored run record
    - Returns 200 with new run_id on success
    - Returns appropriate error codes (400/404/500) on failure
  </done>
</task>

</tasks>

<verification>
After implementation:

1. Verify endpoint returns 200 (not 501) when restarting completed workflow
2. Verify new workflow run appears in database with same inputs
3. Verify running workflows cannot be restarted (returns 400)
4. Verify nonexistent run_id returns 404
5. Verify dashboard UI "Restart" button triggers workflow execution
</verification>

<success_criteria>
1. workflow_restart endpoint no longer returns 501 placeholder
2. Restarting a workflow creates a new WorkflowRunRecord with same inputs
3. Dashboard UI users can restart workflows without CLI access
4. All edge cases handled (running workflows, nonexistent runs)
</success_criteria>

<output>
After completion, create `.planning/phases/03-interfaces-and-triggers/03-04-SUMMARY.md`
</output>
