---
phase: 05-foundation-reliability
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/configurable_agents/storage/factory.py
  - src/configurable_agents/storage/__init__.py
autonomous: true

must_haves:
  truths:
    - "First run creates database tables automatically without errors"
    - "Subsequent runs skip initialization (tables already exist)"
    - "CLI commands work on first run without initialization errors"
    - "Python API works on first run without initialization errors"
    - "UI startup works on first run without initialization errors"
  artifacts:
    - path: "src/configurable_agents/storage/factory.py"
      provides: "ensure_initialized() function with Rich progress feedback"
      min_lines: 50
      contains: ["def ensure_initialized", "def _check_tables_exist", "Base.metadata.create_all"]
    - path: "src/configurable_agents/storage/__init__.py"
      provides: "Public API for ensure_initialized"
      contains: ["ensure_initialized"]
  key_links:
    - from: "src/configurable_agents/cli.py > cmd_run"
      to: "src/configurable_agents/storage/factory.py > ensure_initialized"
      via: "import and call at entry point"
      pattern: "from configurable_agents.storage import ensure_initialized"
    - from: "src/configurable_agents/ui/dashboard/app.py > DashboardApp.__init__"
      to: "src/configurable_agents/storage/factory.py > ensure_initialized"
      via: "import and call on startup"
      pattern: "ensure_initialized\\("
---

<objective>
Implement auto-initialization of databases that runs on first startup, is idempotent, shows progress feedback, and handles failures gracefully with actionable error messages.

**Purpose:** Users can run any command (CLI, Python API, UI) on first run and databases are created automatically without manual setup or initialization errors.

**Output:** `ensure_initialized()` function that checks table existence, creates tables if missing, shows Rich spinner during init, and provides helpful errors for common failures.
</objective>

<execution_context>
@C:\Users\ghost\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\ghost\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/phases/05-foundation-reliability/05-CONTEXT.md
@.planning/phases/05-foundation-reliability/05-RESEARCH.md
@.planning/PROJECT.md
@.planning/ROADMAP.md

# Existing code to enhance
@src/configurable_agents/storage/factory.py
@src/configurable_agents/storage/models.py
@src/configurable_agents/cli.py
@src/configurable_agents/ui/dashboard/app.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ensure_initialized() function to storage factory</name>
  <files>src/configurable_agents/storage/factory.py, src/configurable_agents/storage/__init__.py</files>
  <action>
Add `ensure_initialized()` function to `src/configurable_agents/storage/factory.py` that:
1. Checks if database tables exist using SQLAlchemy's `inspect()`
2. Shows Rich spinner "Initializing database..." if tables need creation
3. Calls `Base.metadata.create_all()` to create all tables
4. Returns `True` if database is ready, `False` if degraded mode

**Implementation details:**

```python
# Add new imports at top
from pathlib import Path
from sqlalchemy import inspect
import logging

logger = logging.getLogger(__name__)

# Add after imports, before create_storage_backend
def _check_tables_exist(engine) -> bool:
    """Check if expected database tables exist.

    Args:
        engine: SQLAlchemy engine instance

    Returns:
        True if all expected tables exist, False otherwise
    """
    inspector = inspect(engine)
    existing_tables = inspector.get_table_names()

    # Expected tables from models.py
    expected_tables = [
        'workflow_runs',           # WorkflowRunRecord
        'execution_states',        # ExecutionStateRecord
        'agents',                  # AgentRecord
        'chat_sessions',           # ChatSessionRecord
        'chat_messages',           # ChatMessage
        'webhook_events',          # WebhookEventRecord
        'memory_records',          # MemoryRecord
        'workflow_registrations',  # WorkflowRegistrationRecord
        'orchestrators',           # OrchestratorRecord
        'session_state',           # SessionState (for crash detection)
    ]

    return all(table in existing_tables for table in expected_tables)


def ensure_initialized(
    db_url: str,
    verbose: bool = False,
    show_progress: bool = True,
) -> bool:
    """Ensure database tables exist, creating them if needed.

    This function is safe to call on every startup - it checks if tables
    exist and only initializes if the database is new.

    Args:
        db_url: SQLAlchemy database URL (e.g., "sqlite:///configurable_agents.db")
        verbose: Enable verbose logging
        show_progress: Show Rich progress spinner during initialization

    Returns:
        True if database is ready, False if running in degraded mode

    Raises:
        PermissionError: If database directory is not writable
        OSError: If disk is full or other IO error occurs
    """
    from configurable_agents.storage.models import Base

    # Extract path from SQLite URL and ensure directory exists
    if db_url.startswith("sqlite:///"):
        db_path = Path(db_url.replace("sqlite:///", ""))
        db_path.parent.mkdir(parents=True, exist_ok=True)

    # Create engine
    engine = create_engine(db_url)

    # Check if tables already exist
    if _check_tables_exist(engine):
        if verbose:
            logger.debug(f"Database already initialized: {db_url}")
        return True

    # Need to initialize - show progress if requested
    if show_progress:
        try:
            from rich.console import Console
            from rich.status import Status

            console = Console()
            with Status(
                "[bold blue]Initializing database...",
                console=console,
                spinner="dots"
            ):
                Base.metadata.create_all(engine)
            console.print("[green]✓[/green] Database initialized successfully")
        except ImportError:
            # Rich not available, initialize without spinner
            logger.info("Initializing database...")
            Base.metadata.create_all(engine)
            logger.info("Database initialized successfully")
    else:
        # No progress display requested
        logger.info("Initializing database...")
        Base.metadata.create_all(engine)
        logger.info("Database initialized successfully")

    # Verify tables were created
    if not _check_tables_exist(engine):
        logger.warning("Database initialization may have failed - some tables missing")
        return False

    return True
```

**Update `src/configurable_agents/storage/__init__.py` to export the function:**

```python
from configurable_agents.storage.factory import (
    create_storage_backend,
    ensure_initialized,
)

__all__ = [
    "create_storage_backend",
    "ensure_initialized",
]
```

**Do NOT:**
- Modify `create_storage_backend()` yet (that's in Task 2)
- Add Alembic migrations (overkill for single-user SQLite)
- Require user to run separate init command
  </action>
  <verify>
# Test that ensure_initialized imports correctly
python -c "from configurable_agents.storage import ensure_initialized; print('Import successful')"

# Test function signature
python -c "from configurable_agents.storage import ensure_initialized; import inspect; sig = inspect.signature(ensure_initialized); assert 'db_url' in sig.parameters; assert 'verbose' in sig.parameters; assert 'show_progress' in sig.parameters"

# Test on a new database
python -c "from configurable_agents.storage import ensure_initialized; result = ensure_initialized('sqlite:///test_init.db', show_progress=False); print(f'Result: {result}'); import os; os.remove('test_init.db')"
  </verify>
  <done>
`ensure_initialized()` function exists in storage module, accepts db_url/verbose/show_progress parameters, creates tables on first run, and skips if tables exist.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add ensure_initialized() to create_storage_backend() and CLI entry points</name>
  <files>src/configurable_agents/storage/factory.py, src/configurable_agents/cli.py, src/configurable_agents/ui/dashboard/app.py</files>
  <action>
Update entry points to call `ensure_initialized()` before using storage.

**In `factory.py`, modify `create_storage_backend()`:**

Replace the existing `Base.metadata.create_all(engine)` call with `ensure_initialized()`:

```python
def create_storage_backend(
    config: Optional[StorageConfig] = None,
    auto_init: bool = True,
) -> Tuple[
    AbstractWorkflowRunRepository,
    AbstractExecutionStateRepository,
    AgentRegistryRepository,
    ChatSessionRepository,
    WebhookEventRepository,
    MemoryRepository,
    WorkflowRegistrationRepository,
    OrchestratorRepository,
]:
    """Create storage backend repositories from configuration.

    Args:
        config: StorageConfig instance. If None, uses defaults (sqlite, ./workflows.db)
        auto_init: Automatically initialize database if tables missing (default: True)

    Returns:
        Tuple of (workflow_run_repository, execution_state_repository,
                  agent_registry_repository, chat_session_repository,
                  webhook_event_repository, memory_repository,
                  workflow_registration_repository, orchestrator_repository)

    Raises:
        ValueError: If backend type is not supported

    Example:
        >>> from configurable_agents.storage import create_storage_backend
        >>> runs_repo, states_repo, agents_repo, chat_repo, webhook_repo, memory_repo, workflow_reg_repo, orchestrator_repo = create_storage_backend()
        >>> run = WorkflowRunRecord(id="123", workflow_name="test", status="running")
        >>> runs_repo.add(run)
    """
    # Use defaults if no config provided
    if config is None:
        config = StorageConfig()

    backend = config.backend
    db_path = config.path
    db_url = f"sqlite:///{db_path}"

    # Handle sqlite backend
    if backend == "sqlite" or backend.startswith("sqlite:///"):
        # Ensure tables exist if auto_init is True
        if auto_init:
            ensure_initialized(db_url, show_progress=False)

        # Create SQLAlchemy engine
        engine = create_engine(db_url)

        # Create repositories
        runs_repo = SQLiteWorkflowRunRepository(engine)
        states_repo = SQLiteExecutionStateRepository(engine)
        agents_repo = SqliteAgentRegistryRepository(engine)
        chat_repo = SQLiteChatSessionRepository(engine)
        webhook_repo = SqliteWebhookEventRepository(engine)
        memory_repo = SQLiteMemoryRepository(engine)
        workflow_reg_repo = SqliteWorkflowRegistrationRepository(engine)
        orchestrator_repo = SqliteOrchestratorRepository(engine)

        return runs_repo, states_repo, agents_repo, chat_repo, webhook_repo, memory_repo, workflow_reg_repo, orchestrator_repo

    # Unsupported backend
    raise ValueError(
        f"Unsupported storage backend: {backend}. "
        f"Supported: 'sqlite'. PostgreSQL coming in Phase 2."
    )
```

**In `cli.py`, add auto-init to `cmd_run()` and other storage-using commands:**

At the start of `cmd_run()`, after config_path validation:

```python
# Auto-initialize database
from configurable_agents.storage import ensure_initialized

from configurable_agents.config.schema import StorageConfig
db_url = f"sqlite:///{StorageConfig().path}"

try:
    if RICH_AVAILABLE and Console:
        from rich.console import Console
        console = Console()
        with console.status("[bold blue]Ensuring database is ready...", spinner="dots"):
            ensure_initialized(db_url, verbose=args.verbose)
    else:
        ensure_initialized(db_url, verbose=args.verbose, show_progress=False)
except Exception as e:
    print_error(f"Database initialization failed: {e}")
    print_info("Check file permissions and disk space")
    return 1
```

**In `dashboard/app.py`, add auto-init to `create_dashboard_app()` and `DashboardApp.__init__()`:**

```python
# In create_dashboard_app(), before creating repositories:
def create_dashboard_app(
    db_url: str = "sqlite:///configurable_agents.db",
    mlflow_tracking_uri: Optional[str] = None,
) -> DashboardApp:
    """Create and configure a dashboard application.

    Factory function for creating a pre-configured DashboardApp instance
    with storage backends initialized from the database URL.

    Args:
        db_url: Database URL for storage backend (default: SQLite)
        mlflow_tracking_uri: Optional MLFlow tracking URI for UI embedding

    Returns:
        Configured DashboardApp instance

    Example:
        >>> app = create_dashboard_app(
        ...     db_url="sqlite:///agents.db",
        ...     mlflow_tracking_uri="file://./mlruns"
        ... )
        >>> import uvicorn
        >>> uvicorn.run(app.get_app(), host="0.0.0.0", port=7861)
    """
    from configurable_agents.storage import ensure_initialized

    # Auto-initialize database
    try:
        ensure_initialized(db_url, show_progress=False)
    except Exception as e:
        logging.getLogger(__name__).warning(f"Database auto-init failed: {e}")

    # Create database engine
    engine = create_engine(db_url, connect_args={"check_same_thread": False})

    # Create repositories
    workflow_repo = SQLiteWorkflowRunRepository(engine)
    agent_repo = SqliteAgentRegistryRepository(engine)

    return DashboardApp(
        workflow_repo=workflow_repo,
        agent_registry_repo=agent_repo,
        mlflow_tracking_uri=mlflow_tracking_uri,
    )
```
  </action>
  <verify>
# Test create_storage_backend with auto_init
python -c "from configurable_agents.storage import create_storage_backend; import os; os.remove('test_auto_init.db') if os.path.exists('test_auto_init.db') else None; repos = create_storage_backend(config=__import__('configurable_agents.config.schema', fromlist=['StorageConfig']).StorageConfig(path='test_auto_init.db'), auto_init=True); print('Auto-init successful'); os.remove('test_auto_init.db')"

# Test that second call works (idempotent)
python -c "from configurable_agents.storage import create_storage_backend; repos1 = create_storage_backend(); repos2 = create_storage_backend(); print('Idempotent calls successful')"
  </verify>
  <done>
`create_storage_backend()` calls `ensure_initialized()` by default. `cmd_run()` and dashboard startup call auto-init before using storage. Database creation is idempotent and silent on subsequent runs.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add error handling for common initialization failures</name>
  <files>src/configurable_agents/storage/factory.py</files>
  <action>
Wrap `ensure_initialized()` with helpful error messages for common failure modes.

**Update `ensure_initialized()` in `factory.py`:**

Add error handling after `Base.metadata.create_all(engine)`:

```python
def ensure_initialized(
    db_url: str,
    verbose: bool = False,
    show_progress: bool = True,
) -> bool:
    """Ensure database tables exist, creating them if needed.

    This function is safe to call on every startup - it checks if tables
    exist and only initializes if the database is new.

    Args:
        db_url: SQLAlchemy database URL (e.g., "sqlite:///configurable_agents.db")
        verbose: Enable verbose logging
        show_progress: Show Rich progress spinner during initialization

    Returns:
        True if database is ready, False if running in degraded mode

    Raises:
        PermissionError: If database directory is not writable
        OSError: If disk is full or other IO error occurs
    """
    from configurable_agents.storage.models import Base

    # Extract path from SQLite URL and ensure directory exists
    if db_url.startswith("sqlite:///"):
        db_path = Path(db_url.replace("sqlite:///", ""))
        try:
            db_path.parent.mkdir(parents=True, exist_ok=True)
        except PermissionError as e:
            raise PermissionError(
                f"Cannot create database directory: {db_path.parent}\n"
                f"Permission denied: {e}\n"
                f"To fix: Check directory permissions or set AGENTS_DB_PATH to a writable location"
            ) from e
        except OSError as e:
            if "No space left on device" in str(e):
                raise OSError(
                    f"Disk full, cannot create database: {db_path}\n"
                    f"To fix: Free up disk space and try again"
                ) from e
            raise

    # Create engine
    engine = create_engine(db_url)

    # Check if tables already exist
    if _check_tables_exist(engine):
        if verbose:
            logger.debug(f"Database already initialized: {db_url}")
        return True

    # Need to initialize - show progress if requested
    try:
        if show_progress:
            try:
                from rich.console import Console
                from rich.status import Status

                console = Console()
                with Status(
                    "[bold blue]Initializing database...",
                    console=console,
                    spinner="dots"
                ):
                    Base.metadata.create_all(engine)
                console.print("[green]✓[/green] Database initialized successfully")
            except ImportError:
                # Rich not available, initialize without spinner
                logger.info("Initializing database...")
                Base.metadata.create_all(engine)
                logger.info("Database initialized successfully")
        else:
            # No progress display requested
            logger.info("Initializing database...")
            Base.metadata.create_all(engine)
            logger.info("Database initialized successfully")
    except PermissionError as e:
        raise PermissionError(
            f"Cannot write to database: {db_url}\n"
            f"To fix:\n"
            f"  1. Check directory permissions\n"
            f"  2. Ensure database directory is writable\n"
            f"  3. Try running with elevated privileges if needed"
        ) from e
    except OSError as e:
        if "No space left on device" in str(e) or "disk full" in str(e).lower():
            raise OSError(
                f"Disk full, cannot write to database\n"
                f"To fix: Free up disk space and try again"
            ) from e
        raise

    # Verify tables were created
    if not _check_tables_exist(engine):
        logger.warning("Database initialization may have failed - some tables missing")
        return False

    return True
```

**Add to CLI error handling in `cmd_run()`:**

```python
except PermissionError as e:
    print_error(f"Database permission error: {e}")
    return 1
except OSError as e:
    print_error(f"Database error: {e}")
    return 1
```
  </action>
  <verify>
# Test permission error handling (simulate by using read-only directory)
# This is a manual test scenario

# Test that the error message is helpful
python -c "
from configurable_agents.storage import ensure_initialized
import sys
try:
    # Try to write to /root/ (should fail on non-root)
    ensure_initialized('sqlite:///root/test.db', show_progress=False)
except PermissionError as e:
    print(f'PermissionError caught: {e}')
    if 'To fix:' in str(e):
        print('✓ Error message includes fix suggestions')
        sys.exit(0)
except Exception as e:
    # On Windows or if /root doesn't exist, might get different error
    print(f'Expected error: {e}')
    sys.exit(0)
"
  </verify>
  <done>
`ensure_initialized()` raises `PermissionError` and `OSError` with helpful "To fix:" suggestions for common failures. CLI commands catch and display these errors clearly.
  </done>
</task>

</tasks>

<verification>
**Overall Phase Verification:**

1. Delete existing database file (if any): `rm configurable_agents.db` or `del configurable_agents.db`
2. Run `configurable-agents run test.yaml` (or any workflow command) and verify database is created automatically
3. Run the command again and verify it skips initialization (no "Initializing database..." message)
4. Test from Python API:
   ```python
   from configurable_agents.storage import ensure_initialized
   ensure_initialized("sqlite:///test_new.db", show_progress=True)
   ```
5. Test UI startup: `configurable-agents ui` (verify database auto-inits before dashboard starts)
</verification>

<success_criteria>
1. First run creates database tables automatically with "Initializing database..." spinner
2. Subsequent runs skip initialization silently
3. Permission errors show "To fix:" suggestions
4. All entry points (CLI, Python API, UI) work on first run
5. Database directory is created automatically if missing
</success_criteria>

<output>
After completion, create `.planning/phases/05-foundation-reliability/05-02-SUMMARY.md` with:
- Auto-initialization implementation details
- Error handling patterns for common failures
- Files modified summary
</output>
